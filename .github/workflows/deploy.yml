name: Deploy Frontend to VPS

on:
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@dc588b651fe13675774614f8e6a936a468676387 # v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          for i in 1 2 3; do
            ssh-keyscan -T 30 -H 147.79.71.176 >> ~/.ssh/known_hosts 2>/dev/null && break
            echo "Retry $i..."
            sleep 5
          done
          cat ~/.ssh/known_hosts | grep -q "147.79.71.176" || exit 1

      - name: Deploy to VPS
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.env' \
            --exclude '.env.local' \
            --exclude '.git' \
            -e ssh \
            . root@147.79.71.176:/var/www/nexora-web/

          ssh root@147.79.71.176 << 'EOF'
            cd /var/www/nexora-web
            npm install
            npm run build
            pm2 restart nexora-web
          EOF

      - name: Health check
        run: |
          sleep 5
          curl -f https://nexoraos.pro || exit 1
